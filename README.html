<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="description" content="Déploiement Kubernetes"><title>Déploiement d&#8217;Applications Kubernetes : Poste de Dev &amp; Intégration Continue</title><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui" name="viewport"><link href="reveal.js/css/reveal.css" rel="stylesheet"><link rel="stylesheet" href="reveal.js/css/theme/white.css" id="theme"><!--This CSS is generated by the Asciidoctor-Reveal.js converter to further integrate AsciiDoc's existing semantic with Reveal.js--><style type="text/css">.reveal div.right {
  float: right;
}

/* callouts */
.conum[data-value] {display:inline-block;color:#fff!important;background-color:rgba(50,150,50,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}</style><link href="highlight.js/src/styles/idea.css" rel="stylesheet"><script>var link = document.createElement( 'link' );
link.rel = 'stylesheet';
link.type = 'text/css';
link.href = window.location.search.match( /print-pdf/gi ) ? "reveal.js/css/print/pdf.css" : "reveal.js/css/print/paper.css";
document.getElementsByTagName( 'head' )[0].appendChild( link );</script><!--[if lt IE 9]><script src="reveal.js/lib/js/html5shiv.js"></script><![endif]--><link rel="stylesheet" href="mystyles.css"></head><body><div class="reveal"><div class="slides"><section class="title" data-state="title"><h1><span class="orange">Déploiement d&#8217;Applications Kubernetes </h1><h2>Poste de Dev &amp; Intégration Continue</span></h2><div class="preamble"> <div id="prez-footer" class="footer">
     <span class="element">#Deploy-Java-Kubernetes</span>
     <span class="element">@LyonJUG</span>
     <span class="element">mehdi.elkouhen@gmail.com</span>
 </div>

 <script type="text/javascript">
     window.addEventListener("load", function() {

         revealDiv = document.querySelector("body div.reveal")
         footer = document.getElementById("prez-footer");
         revealDiv.appendChild(footer);

     } );
 </script></div></section>
<section id="_qui_suis_je"><h2><span class="orange">Qui suis-je ?</span></h2><div class="ulist"><ul><li><p>Mehdi EL KOUHEN</p></li><li><p>Dev Nantais @ SOFTEAM</p></li><li><p>Blog : <a href="https://softeamouest.github.io/" class="bare">https://softeamouest.github.io/</a></p></li><li><p>Email : <a href="mailto:mehdi.elkouhen@gmail.com">mehdi.elkouhen@gmail.com</a></p></li></ul></div></section>
<section><section id="_kubernetes"><h2><span class="orange">Kubernetes</span></h2><div class="paragraph"><p>Gère le Déploiement, Maintenance et Scaling d&#8217;applications conteneurisées</p></div></section><section id="_concepts_kubernetes"><h2>Concepts Kubernetes</h2><div class="ulist"><ul><li class="fragment"><p>Pod : Elémént unitaire de déploiement (1 ou +eurs conteneurs)</p></li><li class="fragment"><p>Replica Set : Gère le nombre de replicas d&#8217;un Pod</p></li><li class="fragment"><p>Deployment : Gère le déploiement, la mise à jour de Pods et Replica Set</p></li><li class="fragment"><p>Service : Point d&#8217;accès (non éphémère) à des pods</p></li></ul></div></section></section>
<section id="_structure_de_lapplication_à_déployer"><h2><span class="orange">Structure de l&#8217;application à déployer</span></h2><div class="ulist"><ul><li><p>1 Front End Web (books-gui)</p></li><li><p>1 Application Java (books-api)</p></li><li><p>1 Base de Données H2 (h2)</p></li></ul></div>
<div class="paragraph"><p>Organisation GitHub : <a href="https://github.com/SofteamOuest-Opus" class="bare">https://github.com/SofteamOuest-Opus</a></p></div></section>
<section><section id="_plan"><h2><span class="orange">Plan</span></h2><div class="ulist"><ul><li class="fragment"><p>Déploiement Impératif</p></li><li class="fragment"><p>Déploiement Déclaratif</p></li><li class="fragment"><p>Packaging des confs de déploiement</p></li><li class="fragment"><p>Déploiement "Poste de Dev"</p></li><li class="fragment"><p>Déploiement "Intégration Continue"</p></li></ul></div></section><section id="_choix_doutils"><h2>Choix d&#8217;Outils</h2><div class="ulist"><ul><li class="fragment"><p>Helm pour le packaging</p></li><li class="fragment"><p>"Poste de Dev"</p><div class="ulist"><ul><li><p>Minikube comme serveur Kubernetes</p></li><li><p>Skaffold pour le déploiement "Poste De Dev"</p></li></ul></div></li><li class="fragment"><p>"Intégration Continue" (i.e. Jenkins)</p><div class="ulist"><ul><li><p>Helmfile pour le déploiement</p></li></ul></div></li></ul></div></section></section>
<section><section id="_déploiement_impératif"><h2><span class="orange">Déploiement Impératif</span></h2></section><section id="_démarrage_du_pod"><h2>Démarrage du POD</h2><pre class="highlight listingblock"><code data-noescape class="bash language-bash"># kubectl run books-api --image opus/books-api
deployment "books-api" created

# kubectl get pod,rs,deploy  -l run=books-api
NAME                            READY     STATUS    RESTARTS   AGE
po/books-api-5649ff5579-5k4q9   1/1       Running   0          35s

NAME                      DESIRED   CURRENT   READY     AGE
rs/books-api-5649ff5579   1         1         1         35s

NAME               DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deploy/books-api   1         1         1            1           35s</code></pre></section><section id="_appel_du_service_books_api_via_ip_pod"><h2>Appel du service books-api (via IP POD)</h2><pre class="highlight listingblock"><code data-noescape class="bash language-bash"># kubectl get pod -o wide -l run=books-api
NAME                         READY   STATUS    RESTARTS   AGE     IP          NODE                NOMINATED NODE
books-api-5649ff5579-khzwn   1/1     Running   0          2m13s   10.46.0.1   vps267694.ovh.net   &lt;none&gt;

# curl http://10.46.0.1:8080/books
[{"id":1,"title":"Design Pattern"},{"id":2,"title":"Effective Java"},{"id":3,"title":"C++"}]</code></pre></section><section id="_création_du_service"><h2>Création du Service</h2><pre class="highlight listingblock"><code data-noescape class="bash language-bash"># kubectl expose deployment books-api --port=80 --target-port=8080 --type=LoadBalancer
service/books-api exposed

# kubectl get svc -l run=books-api
NAME        TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
books-api   LoadBalancer   10.99.244.242   &lt;pending&gt;     80:30254/TCP   15s

# curl http://10.99.244.242/books
[{"id":1,"title":"Design Pattern"},{"id":2,"title":"Effective Java"},{"id":3,"title":"C++"}]</code></pre></section><section id="_appel_du_service_books_api_via_ip_svc"><h2>Appel du Service books-api (via IP SVC)</h2><pre class="highlight listingblock"><code data-noescape class="bash language-bash"># curl http://10.99.244.242/books
[{"id":1,"title":"Design Pattern"},{"id":2,"title":"Effective Java"},{"id":3,"title":"C++"}]

# kubectl delete pod -l run=books-api
pod "books-56d6bd4755-srzvd" deleted

# curl http://10.99.244.242/books
[{"id":1,"title":"Design Pattern"},{"id":2,"title":"Effective Java"},{"id":3,"title":"C++"}]</code></pre></section></section>
<section><section id="_déploiement_déclaratif"><h2><span class="orange">Déploiement Déclaratif</span></h2></section><section id="_démarrage_du_pod_2"><h2>Démarrage du POD</h2><pre class="highlight listingblock"><code data-noescape class="yaml language-yaml">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: books-api
spec:
  template:
    metadata:
      labels:
        run: books-api
    spec:
      containers:
      - image: opus/books-api
        name: books-api</code></pre>
<pre class="highlight listingblock"><code data-noescape class="bash language-bash"># kubectl create -f books-api-deployment.yaml
deployment.extensions/books-api created</code></pre></section><section id="_création_du_service_2"><h2>Création du Service</h2><pre class="highlight listingblock"><code data-noescape class="yaml language-yaml">apiVersion: v1
kind: Service
metadata:
  labels:
    run: books-api
  name: books-api
spec:
  ports:
  - port: 80
    protocol: TCP
    targetPort: 8080
  selector:
    run: books-api
  type: LoadBalancer</code></pre></section></section>
<section><section id="_déploiement_helm"><h2><span class="orange">Déploiement "Helm"</span></h2></section><section id="_helm"><h2>Helm ?</h2><div class="ulist"><ul><li><p>Gestionnaire de Charts Kubernetes <a href="https://helm.sh/" class="bare">https://helm.sh/</a></p><div class="ulist"><ul><li><p>Gestion de templates, variables, &#8230;&#8203;</p></li><li><p>Gestion de dépendances</p></li><li><p><a href="https://github.com/helm/helm/blob/master/docs/related.md#helm-plugins">Plugins</a> (secrets, restore, &#8230;&#8203;)</p></li></ul></div></li></ul></div></section><section id="_création_dun_chart"><h2>Création d&#8217;un Chart</h2><pre class="highlight listingblock"><code data-noescape class="bash language-bash"># helm create books-api
Creating books-api</code></pre></section><section id="_structure_dun_chart"><h2>Structure d&#8217;un Chart</h2><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><thead><tr><th class="tableblock halign-left valign-top">Fichier</th><th class="tableblock halign-left valign-top">Description</th></tr><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Chart.yaml</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Description du Chart (nom, numéros de version du Chart et de l&#8217;application)</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">values.yaml</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Variables du Chart</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">templates</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Répertoire contenant les templates des ressources K8s</p></td></tr></table></section><section id="_release_dun_chart_helm"><h2>Release d&#8217;un Chart Helm</h2><pre class="highlight listingblock"><code data-noescape class="bash language-bash"># helm package --version 0.1.0 books-api
# helm repo index . --url https://softeamouest-opus.github.io/charts</code></pre>
<div class="paragraph"><p>Types de dépôts :</p></div>
<div class="ulist"><ul><li><p>Appli Web Statique (exemple : Dépôt Github)</p></li><li><p><a href="https://github.com/sonatype-nexus-community/nexus-repository-helm">Plugin Nexus</a></p></li><li><p><a href="https://chartmuseum.com/">ChartMuseum</a></p></li></ul></div></section><section id="_déploiement_dun_chart_helm"><h2>Déploiement d&#8217;un Chart Helm</h2><pre class="highlight listingblock"><code data-noescape class="bash language-bash"># helm repo add softeamouest-opus-charts https://softeamouest-opus.github.io/charts
# helm install --name books-api --values values.yaml softeamouest-opus-charts/books-api
# helm list
  NAME        	REVISION	UPDATED                 	STATUS  	CHART              	NAMESPACE
  books-api   	1       	Thu Nov 29 22:29:43 2018	DEPLOYED	books-api-0.1.0    	default</code></pre></section><section id="_statut_du_déploiement"><h2>Statut du Déploiement</h2><pre class="highlight listingblock"><code data-noescape class="bash language-bash"># helm status books-api-dev
LAST DEPLOYED: Tue Jan  8 21:37:41 2019
NAMESPACE: dev
STATUS: DEPLOYED

RESOURCES:
==&gt; v1/Secret
NAME                           TYPE    DATA  AGE
books-api-dev-basicauthsecret  Opaque  1     10s

==&gt; v1/Service
NAME              TYPE       CLUSTER-IP      EXTERNAL-IP  PORT(S)   AGE
books-api-dev-h2  ClusterIP  10.108.255.85   &lt;none&gt;       1521/TCP  10s
books-api-dev     ClusterIP  10.109.152.219  &lt;none&gt;       80/TCP    10s

==&gt; v1beta2/Deployment
NAME              DESIRED  CURRENT  UP-TO-DATE  AVAILABLE  AGE
books-api-dev-h2  1        1        1           1          10s
books-api-dev     1        1        1           1          10s

==&gt; v1/Pod(related)
NAME                               READY  STATUS   RESTARTS  AGE
books-api-dev-h2-7846b98df4-pkpks  1/1    Running  0         10s
books-api-dev-8699874d8f-gb7wz     1/1    Running  0         10s


NOTES:
1. Get the application URL by running these commands:
  https://books-api-dev.k8.wildwidewest.xyz/</code></pre></section></section>
<section><section id="_helm_api_de_gestion_de_livres"><h2><span class="orange">HELM : API de gestion de livres</span></h2><div class="ulist"><ul><li><p>Ajout d&#8217;une dépendance du Chart 'books-api' vers le Chart 'h2'</p></li><li><p>Configuration de la base de données</p></li></ul></div></section><section id="_helm_définition_de_la_dépendance"><h2>Helm - Définition de la dépendance</h2><pre class="highlight listingblock"><code data-noescape class="bash language-bash"># pwd
  /home/elkouhen/charts/books-api

# cat requirements.yaml
dependencies:
- name: h2
  version: 0.1.0
  repository: "file://../h2"
  condition: h2.enabled</code></pre></section><section id="_helm_installation_des_dépendances"><h2>Helm - Installation des dépendances</h2><pre class="highlight listingblock"><code data-noescape class="bash language-bash"># pwd
  /home/elkouhen/charts/books-api

# helm dependency update --skip-refresh
  Saving 1 charts
  Deleting outdated charts</code></pre></section><section id="_helm_configuration_de_lurl_jdbc"><h2>Helm - Configuration de l&#8217;URL JDBC</h2><pre class="highlight listingblock"><code data-noescape class="yaml language-yaml">    spec:
      containers:
        - name: {{ .Chart.Name }}
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
{{- if .Values.h2.enabled}}
          env:
          - name: SPRING_DATASOURCE_URL
            value: jdbc:h2:tcp://{{ .Release.Name }}-h2:1521/~/books
{{- end}}</code></pre></section></section>
<section><section id="_déploiement_poste_de_dev_skaffold"><h2><span class="orange">Déploiement Poste de Dev : Skaffold</span></h2><div class="ulist"><ul><li class="fragment"><p>A chaque modif. des sources</p><div class="ulist"><ul><li><p>Reconstruction  des images Docker</p></li><li><p>Déploiement/Mise à jour de l&#8217;application sur Kubernetes</p></li></ul></div></li><li class="fragment"><p><span class="blue">Pas d&#8217;exigences de sécurité</span></p></li></ul></div></section><section id="_mise_en_place_de_skaffold_cas_classique"><h2>Mise en Place de Skaffold (cas classique)</h2><div class="ulist"><ul><li class="fragment"><p>Créer un Dockerfile "autonome"</p><div class="ulist"><ul><li><p>Le Dockerfile doit orchestrer les outils de build (npm, webpack, &#8230;&#8203;)</p></li></ul></div></li><li class="fragment"><p>Créer la config Skaffold</p></li></ul></div></section><section id="_configuration_skaffold_version_classique"><h2>Configuration Skaffold (version classique)</h2><pre class="highlight listingblock"><code data-noescape class="yaml language-yaml">apiVersion: skaffold/v1beta1
kind: Config
build:
  artifacts:
  - image: localhost:5000/opus-books-gui
deploy:
  helm:
    releases:
    - name: books-gui
      chartPath: ../charts/books-gui
      setValues:
        ingress.enabled: false
        h2.enabled: false
        image.repository: kube-registry:5000/opus-books-gui
        service.type: NodePort
      setValueTemplates:
        image.tag: "{{.DIGEST}}"</code></pre></section><section id="_mise_en_place_de_skaffold_cas_maven"><h2>Mise en Place de Skaffold (cas Maven)</h2><div class="ulist"><ul><li class="fragment"><p>Configurer le plugin Maven jib-maven-plugin</p><div class="ulist"><ul><li><p>Le plugin génère un Dockerfile qui optimise la construction des images Docker pour les applications java</p></li><li><p>La création d&#8217;un Dockerfile n&#8217;est pas nécessaire !</p></li></ul></div></li><li class="fragment"><p>Créer la config Skaffold</p><div class="ulist"><ul><li><p>Configurer jibMaven dans la config. Skaffold</p></li></ul></div></li></ul></div></section><section id="_configuration_skaffold_version_maven"><h2>Configuration Skaffold (version Maven)</h2><pre class="highlight listingblock"><code data-noescape class="yaml language-yaml">apiVersion: skaffold/v1beta1
kind: Config
build:
  artifacts:
  - image: localhost:5000/opus-books-api
    jibMaven: {}
deploy:
  helm:
    releases:
    - name: books-api
      chartPath: ../charts/books-api
      setValues:
        auth.htpassword: dXNlcjE6JGFwcjEkcHFTb3VWTE4kQ2EvQVNKSFhLU2dJSlpsd295andtMQ==
        ingress.enabled: false
        h2.enabled: false
        image.repository: kube-registry:5000/opus-books-api
        service.type: NodePort
      setValueTemplates:
        image.tag: "{{.DIGEST}}"</code></pre></section><section id="_configuration_de_jib"><h2>Configuration de JIB</h2><pre class="highlight listingblock"><code data-noescape class="xml language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;plugin&gt;
   &lt;groupId&gt;com.google.cloud.tools&lt;/groupId&gt;
   &lt;artifactId&gt;jib-maven-plugin&lt;/artifactId&gt;
   &lt;version&gt;0.9.11&lt;/version&gt;
   &lt;configuration&gt;
      &lt;container&gt;
         &lt;jvmFlags&gt;
            &lt;jvmFlag&gt;-Djava.security.egd=file:/dev/./urandom&lt;/jvmFlag&gt;
            &lt;jvmFlag&gt;-XX:+UnlockExperimentalVMOptions&lt;/jvmFlag&gt;
            &lt;jvmFlag&gt;-XX:+UseCGroupMemoryLimitForHeap&lt;/jvmFlag&gt;
         &lt;/jvmFlags&gt;
      &lt;/container&gt;
   &lt;/configuration&gt;
&lt;/plugin&gt;</code></pre></section><section id="_démarrage_de_skaffold"><h2>Démarrage de Skaffold</h2><pre class="highlight listingblock"><code data-noescape class="bash language-bash"># skaffold dev -f skaffold-local.yaml</code></pre></section><section id="_démo"><h2>Démo</h2></section><section id="_test_du_back_end"><h2>Test du back end</h2><pre class="highlight listingblock"><code data-noescape class="bash language-bash">[root@master1 ~]# kubectl get svc
NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
books-api    NodePort    10.109.185.27   &lt;none&gt;        80:31185/TCP   2m
kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP        6m

[root@master1 ~]# curl http://10.109.185.27/books
[{"id":1,"title":"Design Pattern","author":"Erich Gamma, John Vlissides, Ralph E.. Johnson et Richard Helm"},\
{"id":2,"title":"Effective Java","author":"Joshua Bloch"},\
{"id":3,"title":"The C++ Programming Language","author":"Bjarne Stroustrup"},\
{"id":4,"title":"The Clean Coder: A Code of Conduct for Professional Programmers","author":"Robert C. Martin"}]</code></pre></section><section id="_test_du_front_end_via_port_forward"><h2>Test du front end via port-forward</h2><pre class="highlight listingblock"><code data-noescape class="bash language-bash">kubectl port-forward  $(kubectl get pod | grep books-gui | awk '{print $1;}') 9000:80</code></pre></section><section id="_test_du_front_end_via_endpoint_minikube"><h2>Test du front end via endpoint minikube</h2><pre class="highlight listingblock"><code data-noescape class="bash language-bash">minikube service books-api --url</code></pre></section></section>
<section><section id="_déploiement_intégration_continue_jenkins"><h2><span class="orange">Déploiement "Intégration Continue" : Jenkins</span></h2><div class="ulist"><ul><li class="fragment"><p>A chaque commit</p><div class="ulist"><ul><li><p>Reconstruction des images Docker</p></li><li><p>Déploiement des images vers le registry Docker</p></li><li><p>Déploiement/Mise à jour de l&#8217;application sur Kubernetes</p></li></ul></div></li><li class="fragment"><p><span class="red">Fortes exigences de sécurité (gestion de mots de passe, &#8230;&#8203;)</span></p></li></ul></div></section><section id="_mise_en_place_de_jenkins"><h2>Mise en Place de Jenkins</h2><div class="ulist"><ul><li class="fragment"><p>Déployer Jenkins dans le cluster K8s (via helm install jenkins)</p></li><li class="fragment"><p>Créer des Jobs basés sur le <a href="https://github.com/jenkinsci/kubernetes-plugin">plugin kubernetes</a> (extension des Jenkinsfile)</p></li></ul></div></section><section id="_format_des_jobs"><h2>Format des Jobs</h2><pre class="highlight listingblock"><code data-noescape class="groovy language-groovy">podTemplate(label: 'books-api-pod', containers: [
    // construction des images
    containerTemplate(name: 'docker', image: 'docker:18.09', command: 'cat', ttyEnabled: true),

    // déploiement via helm
    containerTemplate(name: 'helm', image: 'elkouhen/k8s-helm:2.9.1c', ttyEnabled: true, command: 'cat')],
) {
    // noeud responsable du build
    node('books-api-pod') {

        container('docker') {
            // taches à exécuter dans le conteneur docker
        }
    }
}</code></pre></section><section id="_construction_des_images"><h2>Construction des Images</h2><pre class="highlight listingblock"><code data-noescape class="groovy language-groovy">container('docker') {

    stage('BUILD') {

        // Injection des Credentials
        withCredentials([string(credentialsId: 'sonarqube_token', variable: 'sonarqube_tok'),
                        string(credentialsId: 'registry_url', variable: 'registry_url')]) {

        // Connexion au Registry Docker
        withDockerRegistry(credentialsId: 'nexus_user', url: "${registry_url}") {

            sh "docker build . --build-arg SONAR_TOKEN=${sonarqube_tok} --tag ${URL}/repository/docker-repository/${IMAGE}:$TAG"
            sh "docker push ${URL}/repository/docker-repository/${IMAGE}:$TAG"
        }
    }
}</code></pre></section><section id="_déploiement_des_charts"><h2>Déploiement des Charts</h2><pre class="highlight listingblock"><code data-noescape class="groovy language-groovy">container('helm') {

    stage('DEPLOY') {

        // Déploiement
        helm repo add softeamouest-opus-charts https://softeamouest-opus.github.io/charts
        helm install --name books-api softeamouest-opus-charts/books-api
    }
}</code></pre></section></section>
<section><section id="_helm_gestion_des_secrets"><h2><span class="orange">HELM - Gestion des Secrets</span></h2><div class="paragraph"><p>Sécuriser l&#8217;accès au frontend via une authentification basique</p></div></section><section id="_plan_2"><h2>Plan</h2><div class="ulist"><ul><li class="fragment"><p>Prerequis technique</p><div class="ulist"><ul><li><p>Génération d&#8217;une clef PGP</p></li><li><p>Encodage des fichiers secrets.yaml via SOPS (basé sur la clef PGP)</p></li><li><p>Modification des fichiers secrets.yaml via helm secrets</p></li></ul></div></li><li class="fragment"><p>Mise en place de l&#8217;authentification</p><div class="ulist"><ul><li><p>Création du secret htpasswd</p></li><li><p>Création de la configuration NGinx</p></li><li><p>Déploiement de l&#8217;application</p></li></ul></div></li></ul></div></section><section id="_génération_dune_clef_pgp"><h2>Génération d&#8217;une clef PGP</h2><pre class="highlight listingblock"><code data-noescape class="bash language-bash">gpg --full-generate-key
gpg (GnuPG) 2.2.8; Copyright (C) 2018 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Sélectionnez le type de clef désiré :
   (1) RSA et RSA (par défaut)
   (2) DSA et Elgamal
   (3) DSA (signature seule)
   (4) RSA (signature seule)
Quel est votre choix ?
les clefs RSA peuvent faire une taille comprise entre 1024 et 4096 bits.
Quelle taille de clef désirez-vous ? (3072)
La taille demandée est 3072 bits
...
Nom réel : opus-softeam
Adresse électronique : mehdi.elkouhen@softeam.fr
Commentaire :
Vous avez sélectionné cette identité :
    « opus-softeam &lt;mehdi.elkouhen@softeam.fr&gt; »</code></pre></section><section id="_création_dun_fichier_metadata_sops"><h2>Création d&#8217;un fichier Metadata SOPS</h2><pre class="highlight listingblock"><code data-noescape class="bash language-bash"># gpg --list-secret-keys
/home/elkouhen/.gnupg/pubring.kbx
---------------------------------
sec   rsa3072 2018-11-26 [SC] [expire : 2019-11-26]
      59D14BD4108D748C3E9FF048EB31F93C01C4EDDC
uid          [  ultime ] opus-softeam &lt;mehdi.elkouhen@softeam.fr&gt;
ssb   rsa3072 2018-11-26 [E] [expire : 2019-11-26]

# cat .sops.yaml
creation_rules:
  - pgp: '59D14BD4108D748C3E9FF048EB31F93C01C4EDDC'</code></pre></section><section id="_création_du_fichier_de_secrets"><h2>Création du fichier de secrets</h2><pre class="highlight listingblock"><code data-noescape class="yaml language-yaml"># sops -i -e secrets.yaml
# cat secrets.yaml
auth:
    htpassword: ENC[AES256_GCM,data:DwM61IYHNpJrX0Qf5DaUbWC2CzcKROFgVFt/Ry8w9t6dVm97M9w1YUMVNQjR8ZKbaGMVfqbL5YBbbAps,iv:rQgGF0kHFq5B6y1GZy6ORx/KMBfWOBf43hVfNRqaLCk=,tag:5H++7uKF1eIEI+uCPvvl/g==,type:str]
sops:
    kms: []
    gcp_kms: []
    lastmodified: '2018-12-12T13:23:55Z'
    mac: ENC[AES256_GCM,data:FbSvNsjuRbPITXGTP1xQw4Clsv7l9x8rfrlebzwPders+2JInX8DBNq8UuvLy2j/CA+QIVF7hBCm3KLdqkwdMhdY5ic4ogIvYRJUJm9Bnvv9bBKvwsXfA/EO6Zler3fXnpQ3ey+ZNurvYqgeMyMB3ft80KTJCxdInYZ7nymFDg8=,iv:oM6d+i+oC8i3tSeuu3apzIsJCXyK86tPJO2NVuxaApA=,tag:c2p7Wy0qVJn2DwrL/fhAjQ==,type:str]
    pgp:
    -   created_at: '2018-12-12T13:23:55Z'
        enc: |
            -----BEGIN PGP MESSAGE-----

            -----END PGP MESSAGE-----
        fp: 0E20EFE4D1A4AC5DBA9DC014FB5D621EBDC94F27
    unencrypted_suffix: _unencrypted
    version: 3.0.3</code></pre></section><section id="_décodage_du_fichier_de_secrets"><h2>Décodage du fichier de secrets</h2><pre class="highlight listingblock"><code data-noescape class="yaml language-yaml"># sops -i -d secrets.yaml</code></pre></section><section id="_edition_du_fichier_de_secrets"><h2>Edition du fichier de secrets</h2><pre class="highlight listingblock"><code data-noescape class="yaml language-yaml"># helm secrets edit secrets.yaml</code></pre></section></section>
<section><section id="_helm_gestion_du_secret_htpasswd"><h2><span class="orange">HELM - Gestion du secret htpasswd</span></h2><div class="ulist"><ul><li><p>Chiffrement du login/mot de passe</p></li></ul></div></section><section id="_création_du_secret_htpasswd"><h2>Création du secret htpasswd</h2><pre class="highlight listingblock"><code data-noescape class="yaml language-yaml"># cat basicauth.yml

apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: {{ .Release.Name }}-basicauthsecret
data:
  auth: {{ .Values.auth.htpassword }}</code></pre></section><section id="_configuration_de_lauthentification_basic_nginx"><h2>Configuration de l&#8217;authentification basic (NGinx)</h2><pre class="highlight listingblock"><code data-noescape class="yaml language-yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    certmanager.k8s.io/issuer: letsencrypt-issuer
    kubernetes.io/ingress.class: nginx
    kubernetes.io/tls-acme: "true"
    nginx.ingress.kubernetes.io/auth-realm: Authentication Required
    nginx.ingress.kubernetes.io/auth-secret:  books-api-basicauthsecret
    nginx.ingress.kubernetes.io/auth-type: basic</code></pre></section><section id="_déploiement_du_package_helm"><h2>Déploiement du Package Helm</h2><pre class="highlight listingblock"><code data-noescape class="bash language-bash"># helm secrets install --name books-api --values secrets.yaml  .</code></pre></section></section>
<section id="_merci"><h2><span class="orange">Merci !!!</span></h2><div class="paragraph"><p>Questions ?</p></div></section></div></div><script src="reveal.js/lib/js/head.min.js"></script><script src="reveal.js/js/reveal.js"></script><script>Array.prototype.slice.call(document.querySelectorAll('.slides section')).forEach(function(slide) {
  if (slide.getAttribute('data-background-color')) return;
  // user needs to explicitly say he wants CSS color to override otherwise we might break custom css or theme (#226)
  if (!(slide.classList.contains('canvas') || slide.classList.contains('background'))) return;
  var bgColor = getComputedStyle(slide).backgroundColor;
  if (bgColor !== 'rgba(0, 0, 0, 0)' && bgColor !== 'transparent') {
    slide.setAttribute('data-background-color', bgColor);
    slide.style.backgroundColor = 'transparent';
  }
})

// See https://github.com/hakimel/reveal.js#configuration for a full list of configuration options
Reveal.initialize({
  // Display presentation control arrows
  controls: true,
  // Help the user learn the controls by providing hints, for example by
  // bouncing the down arrow when they first encounter a vertical slide
  controlsTutorial: true,
  // Determines where controls appear, "edges" or "bottom-right"
  controlsLayout: 'bottom-right',
  // Visibility rule for backwards navigation arrows; "faded", "hidden"
  // or "visible"
  controlsBackArrows: 'faded',
  // Display a presentation progress bar
  progress: true,
  // Display the page number of the current slide
  slideNumber: 'False',
  // Control which views the slide number displays on
  showSlideNumber: 'all',
  // Push each slide change to the browser history
  history: true,
  // Enable keyboard shortcuts for navigation
  keyboard: true,
  // Enable the slide overview mode
  overview: true,
  // Vertical centering of slides
  center: true,
  // Enables touch navigation on devices with touch input
  touch: true,
  // Loop the presentation
  loop: false,
  // Change the presentation direction to be RTL
  rtl: false,
  // Randomizes the order of slides each time the presentation loads
  shuffle: false,
  // Turns fragments on and off globally
  fragments: true,
  // Flags whether to include the current fragment in the URL,
  // so that reloading brings you to the same fragment position
  fragmentInURL: false,
  // Flags if the presentation is running in an embedded mode,
  // i.e. contained within a limited portion of the screen
  embedded: false,
  // Flags if we should show a help overlay when the questionmark
  // key is pressed
  help: true,
  // Flags if speaker notes should be visible to all viewers
  showNotes: false,
  // Global override for autolaying embedded media (video/audio/iframe)
  // - null: Media will only autoplay if data-autoplay is present
  // - true: All media will autoplay, regardless of individual setting
  // - false: No media will autoplay, regardless of individual setting
  autoPlayMedia: null,
  // Number of milliseconds between automatically proceeding to the
  // next slide, disabled when set to 0, this value can be overwritten
  // by using a data-autoslide attribute on your slides
  autoSlide: 0,
  // Stop auto-sliding after user input
  autoSlideStoppable: true,
  // Use this method for navigation when auto-sliding
  autoSlideMethod: Reveal.navigateNext,
  // Specify the average time in seconds that you think you will spend
  // presenting each slide. This is used to show a pacing timer in the
  // speaker view
  defaultTiming: 120,
  // Enable slide navigation via mouse wheel
  mouseWheel: false,
  // Hides the address bar on mobile devices
  hideAddressBar: true,
  // Opens links in an iframe preview overlay
  // Add `data-preview-link` and `data-preview-link="false"` to customise each link
  // individually
  previewLinks: false,
  // Transition style (e.g., none, fade, slide, convex, concave, zoom)
  transition: 'slide',
  // Transition speed (e.g., default, fast, slow)
  transitionSpeed: 'default',
  // Transition style for full page slide backgrounds (e.g., none, fade, slide, convex, concave, zoom)
  backgroundTransition: 'fade',
  // Number of slides away from the current that are visible
  viewDistance: 3,
  // Parallax background image (e.g., "'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg'")
  parallaxBackgroundImage: '',
  // Parallax background size in CSS syntax (e.g., "2100px 900px")
  parallaxBackgroundSize: '',
  // Number of pixels to move the parallax background per slide
  // - Calculated automatically unless specified
  // - Set to 0 to disable movement along an axis
  parallaxBackgroundHorizontal: null,
  parallaxBackgroundVertical: null,
  // The display mode that will be used to show slides
  display: 'block',

  // The "normal" size of the presentation, aspect ratio will be preserved
  // when the presentation is scaled to fit different resolutions. Can be
  // specified using percentage units.
  width: 1600,
  height: 800,

  // Factor of the display size that should remain empty around the content
  margin: 0.1,

  // Bounds for smallest/largest possible scale to apply to content
  minScale: 0.2,
  maxScale: 1.5,

  // Optional libraries used to extend on reveal.js
  dependencies: [
      { src: 'reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
      { src: 'reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
      { src: 'reveal.js/plugin/zoom-js/zoom.js', async: true },
      { src: 'reveal.js/plugin/notes/notes.js', async: true },
      
      
      
      
  ],

  

});</script></body></html>